{% extends 'referral/base.html' %}
{% load forms %}
{% block panel_body %}

<div class="row">
  <div class="col-md-6 col-md-offset-3">
    <p class="lead" ng-show="state == 'initial'">
      <b>Who</b> are you [[ route.progressive_verb.toLowerCase() ]] to [[ route.name ]] ?
    </p>
    {% block has_demographics_title %}
    <p class="lead" ng-show="state == 'has_demographics'">
      We've found [[ patient.demographics[0].first_name ]] [[ patient.demographics[0].surname ]]
    </p>
    <p class="lead" ng-show="state == 'merge_demographics'">
      [[ patient.old_hospital_number ]] has been merged into
      [[ patient.demographics[0].first_name ]] [[ patient.demographics[0].surname ]]
    </p>
    <div  ng-show="state == 'editing_demographics'">
      <p class="lead">
        We couldn't find any patients with this hospital number.
      </p>
      <p class="lead">
        If the patient is unknown to the hospital you could add them as an elCID
        only patient
      </p>
    </div>
    {% endblock %}
    {% block additional_models_title %}
    {% endblock %}
    <p class="lead" ng-show="state == 'success'">
      <i class="fa fa-check"></i> [[ route.past_verb ]] [[ patient.demographics[0].first_name ]] [[ patient.demographics[0].surname ]] to
      <span ng-show="success_link" >
        <a href="[[ success_link ]]">[[ route.name ]]</a>.
      </span>
      <span ng-hide="success_link">[[ route.name ]].</span>
    </p>

  </div>
</div>

<div class="row">
  <div class="col-md-6 col-md-offset-3">
    <div class="panel panel-default">
      <div class="panel-heading">
        <h3 ng-hide="currentAdditionalData()">
          <i class="fa fa-user"></i>
          Patient Details
        </h3>
        <h3 ng-show="currentAdditionalData()">
          {% block additional_models_header %}
          {% endblock %}
        </h3>
      </div>
      <div class="panel-body">

        <!-- Initial state - enter hospital numbe -->
        <div class="row" ng-show="state == 'initial'">
          <div class="col-sm-8">
            <h4>Hospital number</h4>
            <input autofocus class="form-control" type="text"
                   ng-model="hospital_number"
                   ng-keypress="$event.keyCode == 13 && lookup_hospital_number()"
                   />
            <br />
            <button class="btn btn-lg btn-primary" ng-click="lookup_hospital_number()">
              <i class="fa fa-search"></i>
              Search
            </button>
            <br />
            <p>
              If we already have your patient on the system, we can pull their
              details for you
            </p>
          </div>

        </div>



        <!-- Editing demographics state -->
        <div class="row" ng-show="state == 'editing_demographics'">
          <div class="row">
            <div class="col-md-12">
              <form class="form-horizontal">

	        <div class="form-group">
	          <label class="control-label col-sm-3">Hospital</label>
                  <label class="control-label col-sm-8 text-left">
                    [[ hospital_number ]]
                  </label>
	        </div>

                {% input "autofocus" label="First name" model="patient.demographics[0].first_name" %}
                {% input label="Surname" model="patient.demographics[0].surname" %}
	        <div class="form-group">
	          <label class="control-label col-sm-3">Date of birth</label>
	          <div class="col-sm-8">
	            <input class="form-control"
                           type="text"
                           name="date_of_birth"
		           ng-model="patient.demographics[0].date_of_birth"
		           ng-model-options="{ updateOn: 'blur' }"
		           ng-pattern="/^(0?[1-9]|[12][0-9]|3[01])\/(0?[1-9]|1[012])\/(\d{4})$/"
		           placeholder="dd/mm/yyyy" />
                    <span class="help-block" ng-show="newEpisodeForm.date_of_birth.$invalid">
                      Date of Birth must be dd/mm/yyyy
                    </span>
	          </div>
	        </div>
                {% select label="Sex" model="patient.demographics[0].sex" lookuplist="gender_list" %}
              </form>
            </div>
            <div class="col-md-10 col-md-offset-1">
              {% include "referral/_includes/back_button.html" %}
              <button class="btn btn-lg btn-primary pull-right"
                      ng-click="nextStep()">
                <i class="fa fa-arrow-right"></i>
                <span ng-if="!getNextStep()">
                  [[ route.verb ]] to [[ route.name ]]
                </span>
                <span ng-if="getNextStep()">
                  [[ getNextStep().display_name ]]
                </span>
              </button>

            </div>

          </diV>
        </div>
        <span ng-show="state === 'has_demographics' || state === 'merge_demographics' || state === 'success'">
          <div class="row">
            <div class="col-sm-8">
              <div class="row">
                <div class="col-md-4">
                  <b>Hospital #</b>
                </div>
                <div class="col-md-8">
                  [[ hospital_number ]]
                </div>
              </div>
              <div class="row">
                <div class="col-md-4">
                  <b>Name</b>
                </div>
                <div class="col-md-8">
                  [[ patient.demographics[0].first_name ]]
                  [[ patient.demographics[0].surname ]]
                </div>
              </div>
              <div class="row">
                <div class="col-md-4">
                  <b>Date of Birth</b>
                </div>
                <div class="col-md-8">
                  [[ patient.demographics[0].date_of_birth | shortDate ]]
                </div>
              </div>
              <div class="row">
                <div class="col-md-4">
                  <b>Sex</b>
                </div>
                <div class="col-md-8">
                  [[ patient.demographics[0].sex ]]
                </div>
              </div>
              <br />
            </div>
          </div>
        </span>

        <div class="row">
          <div class="col-sm-12">
            <p>
              {% block has_demographics_buttons %}
              <span ng-show="state == 'has_demographics' || state == 'merge_demographics'">
              <!-- <button class="btn btn-lg btn-secondary" ng-click="edit_demographics()"> -->
              <!--   <i class="fa fa-edit"></i> -->
              <!--   Change details -->
              <!-- </button> -->
                {% include "referral/_includes/back_button.html" %}
                <button class="btn btn-lg btn-primary pull-right"
                        ng-show="state == 'has_demographics' || state == 'merge_demographics'"
                        ng-click="nextStep()">
                  <i class="fa fa-arrow-right"></i>
                  <span ng-if="!getNextStep()">
                    [[ route.verb ]] to [[ route.name ]]
                  </span>
                  <span ng-if="getNextStep()">
                    [[ getNextStep().display_name ]]
                  </span>
                </button>
              </span>
              {% endblock has_demographics_buttons %}
              <button class="btn btn-lg btn-primary pull-right"
                      ng-if="state == 'success'"
                      ng-click="back()">
                <i class="fa fa-arrow-right"></i>
                [[ route.verb ]] another
              </button>
            </p>
          </div>
        </div>

        {% block additional_models %}
        {% endblock additional_models %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
